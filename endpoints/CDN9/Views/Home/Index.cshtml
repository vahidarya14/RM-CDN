@using CDN9.Core.Application
@inject IWebHostEnvironment hostEnvironment;
@model (List<D> Dires, List<D> files)
@{
    var baseurl = "home";
}

<input id="fullPathOffile" class="d-none" type="file" />
@* <div class="row justify-content-center">
	<div class="col-8">
		<input id="fullPathOfDir" class="form-control text-left ltr" readonly />
	</div>
</div> *@
<div class="container-fluid fm_sidebar overflow-hidden">
    <div class="row" style="height:100vh;">
        <div class="col-4 col-lg-3 px-0 py-2 position-relative border-end">
            @* <div class="border-bottom py-2" style="margin-left:-11px;margin-right:-11px;">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" onclick="addDirectoryModal('','','mainDirecories')" class="btn btn-outline-dark ">➕Directory</button>
                </div>
            </div> *@
            <div class="" style="overflow-y: auto;
                                 height: 98vh;
                                 overflow-x: hidden;">
                <div class="" style="display:inline-flex">
                    @* <div class="dropdown">
                        <button class="btn btn-link btn-sm" type="button" data-bs-toggle="dropdown">
                            ⋮
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" onclick="showUploadModal('/','/','dir_-1')" href="#">📤Upload File</a></li>
                        </ul>
                    </div> *@
                    <label class="p-2 ps-0 d_-1" onclick="loadSub(-1,'/')" title="Root">💽 /</label>
                </div>
                <div id="dir_-1" class="ms-3"></div>
                <div class="mainDirecories">
                    @for (var i = 0; i < Model.Dires.Count; i++)
                    {
                        var item = Model.Dires[i];
                        <div class="" style="display:inline-flex">
                            <div class="dropdown">
                                <button class="btn btn-link btn-sm" type="button" data-bs-toggle="dropdown">
                                    ⋮
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" onclick="showUploadModal('@item.Path','/','dir_@i')" href="#">📤Upload File</a></li>
                                    <li><a class="dropdown-item" onclick="addDirectoryModal('@item.Path','@item.Text','dir_@i')" href="#">➕Sub Directory</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" onclick="removeDir('@item.Path','/','dir_@i')" href="#">🗑️Remove</a></li>
                                </ul>
                            </div>
                            <label class="p-2 ps-0 folder d_@i" onclick="loadSub(@i,'@item.Path')" title="@item.Text">@item.Text</label>
                        </div>
                        <div id="dir_@i" class="ms-3"></div>
                    }
                </div>
            </div>
        </div>
        <div class="col-8 col-lg-9 position-relative">
            <div class="border-bottom pt-1 px-2" style="margin-left:-11px;margin-right:-11px;padding-bottom: 3px;">
                <div class="row">
                    <div class="col-2 pt-2">
                        <label style="white-space: nowrap;">
                            <input type="checkbox" id="check_all_file" onchange="togglecheckAllByClass()" />
                            All
                        </label>
                    </div>
                    <div class="col">
                        <div class="input-group">
                            <input type="text" id="search_files" class="form-control" placeholder="search...">
                            <button class="btn btn-outline-secondary btn-sm input-group-text" onclick="loadSub('','')">🔍</button>
                            <button class="btn btn-outline-secondary btn-sm input-group-text mx-1" onclick="showUploadModal(lastFolder,'/','dir_'+lastI0)">📤</button>
                            <button class="btn btn-outline-secondary btn-sm input-group-text" onclick="addDirectoryModal(lastFolder,lastFolder,'dir_'+lastI0)">➕</button>
                        </div>
                    </div>
                    <div class="col pt-2">
                        <button class="btn btn-outline-dark  btn-sm float-end me-4" id="select_all_and_close" onclick="getSelectedFilesandPushToParent()">push up ✔</button>
                    </div>
                </div>
            </div>
            <div style="overflow: auto;
                        position: absolute;
                        top: 42px;
                        left: 0;
                        right: 0;
                        bottom: 23px;
                        padding: 0;">

                <table id="files_" class="ml-3  w-100">
                    @for (var i = 0; i < Model.files.Count; i++)
                    {
                        var f = Model.files[i];
                        var j = i;
                        <tr id="file_@j">
                            <td class="py-1 px-2" style="display:inline-flex">
                                <label style='white-space: nowrap;'>
                                    <input type="checkbox" value='@f.Path/@f.Text' class="_files" />
                                </label>
                                <label onclick="showFile2('@f.Path','@f.Text','@f.Extension')" id="file_lbl_@j" title="(@f.Length) - @f.Path">
                                    @f.Text
                                </label>

                                <div class="dropdown">
                                    <button class="btn btn-link btn-sm" type="button" data-bs-toggle="dropdown">
                                        ⋮
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" onclick="showRenameFileModal('@f.Path/@f.Text','@f.Text',@j)" href="#">✏️Rename</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" onclick="removeFile('@f.Path/@f.Text',@j)" href="#">🗑️Remove</a></li>
                                    </ul>
                                </div>
                            </td>
                            <td><small>@f.Length</small></td>
                        </tr>
                    }
                </table>
                
            </div>
            <div class="border-top" style="overflow: auto;
                        position: absolute;
                        left: 0;
                        right: 0;
                        bottom: 0px;
                        padding: 0;">
                <span class="me-2"><strong class="me-2 total-file-count">@Model.files.Count</strong>items</span>|
                <span class="me-2">
                    @{
                        var Length = Model.files.Sum(x => x.LengthByte);
                    }
                    <strong class="total-file-size"> @(Length < 1024 ? $"{Length}" : Length < 1_000_000 ? $"{(long)(Length / 1024)}" : $"{(long)(Length / 1000000)}")</strong>
                    <span class="total-file-style">@(Length < 1024 ? $"B" : Length < 1_000_000 ? $"Kb" : $"Mb")</span>
                </span>
            </div>
        </div>
    </div>
</div>


<div class="modal" tabindex="-1" id="detailModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-1" id="showDetailModal" style="    min-height: 174px;">
            </div>
            @*<div class="modal-footer">
			</div> *@
        </div>
    </div>
</div>

<div class="modal" tabindex="-1" id="myModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-1" id="showModal">
            </div>
            @*<div class="modal-footer">
			</div> *@
        </div>
    </div>
</div>


<div class="modal" tabindex="-1" id="uploadModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body ">
                @Html.AntiForgeryToken()

                <div class="mb-3">
                    <input type="file" id="lastuploadFileInput" multiple class="form-control" />
                </div>

                <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" name="change_img_format">
                    <label class="form-check-label" for="flexSwitchCheckDefault">change image format to .webp</label>
                </div>

                <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" name="add_watermask_to_img">
                    <label class="form-check-label" for="flexSwitchCheckDefault">add watermask to image</label>
                    <img src="/watermask.png" />
                </div>

                <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" name="make_sm_img_too">
                    <label class="form-check-label" for="make_sm_img_too">make_sm_img_too</label>
                </div>

                <button class="btn btn-primary" onclick="uploadfileToServer()">📤Upload File</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="/site.js"></script>
    <script>
        function uploadfileToServer() {

            var e = $("#lastuploadFileInput")[0];
            var formData = new FormData();
            formData.append("__RequestVerificationToken", $("[name='__RequestVerificationToken']").val());
            formData.append("folder", _lastuploadFilePath.path);
            for (let i = 0; i < e.files.length; i++)
                formData.append(`formFile${i}`, e.files[i]);

            formData.append(`change_img_format`, $('[name=change_img_format]').is(':checked'));
            formData.append(`add_watermask_to_img`, $('[name=add_watermask_to_img]').is(':checked'));
            formData.append(`make_sm_img_too`, $('[name=make_sm_img_too]').is(':checked'));

            $.ajax({
                type: "POST",
                url: "@Html.Raw(Url.Action("Upload", baseurl))",
                data: formData,
                processData: false,  // tell jQuery not to process the data
                contentType: false,  // tell jQuery not to set contentType
                success: function (res) {
                    uploadModal.hide();
                    lastFolder="";
                    loadSub(_lastuploadFilePath.i0.replace("dir_",""), _lastuploadFilePath.path);
                    _lastuploadFilePath = "";
                    document.getElementById('lastuploadFileInput').value= null;
                }
            });
        }
    </script>
}


